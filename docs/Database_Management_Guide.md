# ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ê°€ì´ë“œ (Database Management Guide)

ì´ ë¬¸ì„œëŠ” ë³¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” **SQLite ë°ì´í„°ë² ì´ìŠ¤(`data/metadata.db`)**ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì•„ì£¼ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.
ìˆ˜ì‹­ë§Œ ê°œì˜ ì˜¤ë””ì˜¤ íŒŒì¼ ê²½ë¡œì™€ ë©”íƒ€ì •ë³´(ê¸¸ì´, í™”ì, ì–¸ì–´ ë“±)ë¥¼ DBì— ì €ì¥í•´ë‘ê³ , í•™ìŠµ ì‹œì— ì´ë¥¼ ê³ ì†ìœ¼ë¡œ ì¡°íšŒí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

---

## ğŸš€ 1. ê°€ì¥ ì‰¬ìš´ ì‚¬ìš©ë²• (CLI ë„êµ¬)

ë³µì¡í•œ ì½”ë“œ ì—†ì´, í„°ë¯¸ë„ ëª…ë ¹ì–´ë¡œ ë°ì´í„°ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ëŠ” `scripts/manage_db.py`ì…ë‹ˆë‹¤.
ëª¨ë“  ëª…ë ¹ì–´ëŠ” `uv run`ì„ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

### ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ í˜„í™© í™•ì¸ (Stats)
í˜„ì¬ DBì— ì €ì¥ëœ íŒŒì¼ ê°œìˆ˜ì™€ ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬, **ìƒ˜í”Œ ë ˆì´íŠ¸ í˜„í™©**ì„ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
uv run python3 scripts/manage_db.py stats
```

### ğŸ”„ ê²½ë¡œ ìë™ ë™ê¸°í™” (Sync)
`.wav` íŒŒì¼ì„ `.npy`ë¡œ ë³€í™˜í–ˆê±°ë‚˜ íŒŒì¼ ìœ„ì¹˜ë¥¼ ì˜®ê²¼ì„ ë•Œ, DBì— ì €ì¥ëœ ê²½ë¡œë¥¼ ì‹¤ì œ íŒŒì¼ê³¼ ì¼ì¹˜í•˜ë„ë¡ ìë™ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
```bash
uv run python3 scripts/manage_db.py sync
```

### ğŸ”Š ë…¸ì´ì¦ˆ ë°ì´í„° ì¶”ê°€í•˜ê¸°
ìƒˆë¡œìš´ ë…¸ì´ì¦ˆ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ê±°ë‚˜ ë…¹ìŒí–ˆë‹¤ë©´, ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ DBì— ë“±ë¡í•˜ì„¸ìš”. ì‚¬ìš©ìê°€ ì§ì ‘ ì¹´í…Œê³ ë¦¬ë¥¼ ì§€ì •í•  ìˆ˜ ìˆì–´ ê´€ë¦¬ê°€ ìš©ì´í•©ë‹ˆë‹¤.

**ê¸°ë³¸ ëª…ë ¹ì–´ í¬ë§·:**
```bash
uv run python3 scripts/manage_db.py noise \
    --path "[í´ë” ê²½ë¡œ]" \
    --dataset "ë°ì´í„°ì…‹ì´ë¦„" \
    --category "[ëŒ€ë¶„ë¥˜]" \
    --sub "[ì†Œë¶„ë¥˜]"
```

**ì‹¤ì „ ì˜ˆì‹œ (ì‹¬ë³¼ë¦­ ë§í¬ í™œìš©):**
D ë“œë¼ì´ë¸Œì— ìˆëŠ” `Living_Noise` í´ë”ë¥¼ í”„ë¡œì íŠ¸ë¡œ ì—°ê²°í•´ ë“±ë¡í•˜ëŠ” ê²½ìš°:

1. **ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±**:
   ```bash
   ln -s "/mnt/d/New_Noise_Data" data/raw/noise/new_living_noise
   ```

2. **DBì— ë“±ë¡**:
   ```bash
   uv run python3 scripts/manage_db.py noise \
       --path data/raw/noise/new_living_noise \
       --dataset "LivingNoise_v1" \
       --category "ìƒí™œì†ŒìŒ" \
       --sub "ì²­ì†Œê¸°"
   ```

### ğŸ—£ï¸ ìŒì„±(Speech) ë°ì´í„° ì¶”ê°€í•˜ê¸°
KsponSpeech ê°™ì€ ëŒ€ìš©ëŸ‰ ìŒì„± ë°ì´í„°ë¥¼ ì¶”ê°€í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. í™”ì(Speaker)ì™€ ì–¸ì–´(Language) ì •ë³´ë¥¼ ëª…ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
uv run python3 scripts/manage_db.py speech \
    --path data/speech/KsponSpeech \
    --dataset KsponSpeech \
    --language "ko" \
    --speaker "Kspon_0001" 
    # speaker ìƒëµ ì‹œ í´ë”ëª…ì—ì„œ ìë™ ì¶”ë¡ 
```

### ğŸ›ï¸ RIR (ê³µê°„ ìŒí–¥) ë°ì´í„° ì¶”ê°€í•˜ê¸°
ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ìƒì„±ëœ RIR íŒŒì¼(`.wav` ë˜ëŠ” `.pkl`)ì´ ìˆëŠ” í´ë”ë¥¼ í†µì§¸ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.

```bash
uv run python3 scripts/manage_db.py rir \
    --path data/rirs \
    --dataset "Generated_RIR" \
    --split "train"
```

---

## ï¿½ï¸ ë°ì´í„° ë¶„í•  ë° ê³ ì • ì •ì±… (Split Policy) - **ì¤‘ìš”**

### 1. ë°ì´í„° ë¶„í•  ì¬ë°°ì¹˜ (`realloc`)
DBì— ë“±ë¡ëœ ë°ì´í„°ë¥¼ Train:Val:Test (ê¸°ë³¸ 8:1:1) ë¹„ìœ¨ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤.

```bash
uv run python3 scripts/manage_db.py realloc --type speech --ratio 0.8 0.1 0.1
uv run python3 scripts/manage_db.py realloc --type noise --ratio 0.8 0.1 0.1
uv run python3 scripts/manage_db.py realloc --type rir --ratio 0.8 0.1 0.1
```

### 2. ê³ ì • ë¶„í•  ì •ì±… (Fixed Split Policy)
ë³¸ ì‹œìŠ¤í…œì€ ë°ì´í„°ì…‹ í™•ì¥ ì‹œì˜ **ë°ì´í„° ëˆ„ìˆ˜(Data Leakage)**ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì ì§„ì  ë¶„í•  ë°©ì‹ì„ ì±„íƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.

- **ì‘ë™ ì›ë¦¬**: `realloc` ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ, **ì´ë¯¸ `val`ì´ë‚˜ `test`ë¡œ ì§€ì •ëœ ë°ì´í„°ëŠ” ì ˆëŒ€ `train`ìœ¼ë¡œ ëŒì•„ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤.** (Anchoring)
- **íš¨ê³¼**: ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ê³  ë‹¤ì‹œ `realloc`ì„ ëŒë ¤ íŒŒí‹°ì…˜ì„ í™•ì¥í•˜ë”ë¼ë„, ê¸°ì¡´ì— êµ¬ì¶•ëœ ê²€ì¦/í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ ì¼ê´€ë˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤. ì¦‰, ê¸°ì¡´ ëª¨ë¸ í‰ê°€ ê²°ê³¼ì˜ ì‹ ë¢°ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

---

## ğŸ’» 2. íŒŒì´ì¬ ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ê¸° (API)

Jupyter Notebookì´ë‚˜ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì§ì ‘ DBë¥¼ ì¡°ì‘í•˜ê³  ì‹¶ë‹¤ë©´ `DatabaseManager`ë¥¼ importí•´ì„œ ì“°ì„¸ìš”.

```python
from src.db import create_db_engine, DatabaseManager

# 1. DB ì—°ê²° (ì—”ì§„ ìƒì„±)
engine = create_db_engine("data/metadata.db")

# 2. ë§¤ë‹ˆì € ì´ˆê¸°í™”
manager = DatabaseManager(engine)

# 3. ë°ì´í„° ë“±ë¡
# ë…¸ì´ì¦ˆ ì¶”ê°€
manager.index_noise(
    root_dir="data/raw/noise/server_room", 
    dataset_name="ServerNoise",
    category="machine",
    sub_category="fan"
)

# ìŒì„± ì¶”ê°€
manager.index_speech(
    root_dir="data/raw/speech/new_speaker",
    dataset_name="MyCustomVoice",
    language="en"
)
```

---

## ğŸ—ï¸ 3. ë°ì´í„° êµ¬ì¡° (Schema)

DB ë‚´ë¶€ ìŠ¤í‚¤ë§ˆ(`src/data/models.py`)ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

### Table: `speechfile`
| í•„ë“œëª… | ì„¤ëª… | ì˜ˆì‹œ |
| :--- | :--- | :--- |
| `id` | ê³ ìœ  ë²ˆí˜¸ | 1 |
| `path` | íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ (Unique) | `/home/user/data/speech/file.wav` |
| `dataset_name` | ë°ì´í„°ì…‹ ì´ë¦„ | `KsponSpeech` |
| `speaker` | í™”ì ì‹ë³„ì | `Kspon_0001` |
| `language` | ì–¸ì–´ ì½”ë“œ | `ko` |
| `duration_sec` | ì˜¤ë””ì˜¤ ê¸¸ì´ (ì´ˆ) | 4.52 |
| `sample_rate` | ìƒ˜í”Œ ë ˆì´íŠ¸ (Hz) | 16000 |
| `split` | ë¶„í•  ì˜ì—­ | `train` |

### Table: `noisefile`
| í•„ë“œëª… | ì„¤ëª… | ì˜ˆì‹œ |
| :--- | :--- | :--- |
| `id` | ê³ ìœ  ë²ˆí˜¸ | 1 |
| `path` | íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ (Unique) | `/home/user/data/noise/car.wav` |
| `dataset_name` | ë°ì´í„°ì…‹ ì´ë¦„ | `UrbanSound` |
| `category` | ëŒ€ë¶„ë¥˜ (ì‚¬ìš©ì ì…ë ¥) | `êµí†µìˆ˜ë‹¨` |
| `sub_category` | ì†Œë¶„ë¥˜ (ì‚¬ìš©ì ì…ë ¥) | `ì°¨ëŸ‰ì†ŒìŒ` |
| `duration_sec` | ì˜¤ë””ì˜¤ ê¸¸ì´ (ì´ˆ) | 10.0 |
| `sample_rate` | ìƒ˜í”Œ ë ˆì´íŠ¸ (Hz) | 16000 |
| `split` | ë¶„í•  ì˜ì—­ | `train` |

### Table: `rirfile`
| í•„ë“œëª… | ì„¤ëª… | ì˜ˆì‹œ |
| :--- | :--- | :--- |
| `id` | ê³ ìœ  ë²ˆí˜¸ | 1 |
| `path` | íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ (Unique) | `/home/user/data/rirs/rir_00001.pkl` |
| `dataset_name` | ë°ì´í„°ì…‹ ì´ë¦„ | `SimulatedRIR` |
| `room_type` | ë°© í˜•íƒœ | `shoebox` |
| `num_noise` | ë…¸ì´ì¦ˆ ì†ŒìŠ¤ ê°œìˆ˜ | 4 |
| `num_mic` | ë§ˆì´í¬ ê°œìˆ˜ | 4 |
| `num_bcm` | ê³¨ì „ë„ ì„¼ì„œ ê°œìˆ˜ | 1 |
| `rt60` | ì”í–¥ ì‹œê°„ (ì´ˆ) | 0.35 |
| `duration_sec` | RIR ê¸¸ì´ (ì´ˆ) | 2.0 |
| `split` | ë¶„í•  ì˜ì—­ | `train` |

---

## â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)

**Q. ë…¸ì´ì¦ˆ í´ë”ì— íŒŒì¼ í•˜ë‚˜ë§Œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ì „ì²´ë¥¼ ë‹¤ì‹œ ì¸ë±ì‹±í•´ì•¼ í•˜ë‚˜ìš”?**  
A. ë„¤, `manage_db.py` ëª…ë ¹ì–´ë¥¼ ë˜‘ê°™ì´ ë‹¤ì‹œ ì‹¤í–‰í•˜ì‹œë©´ ë©ë‹ˆë‹¤.  
ë‚´ë¶€ì—ì„œ **"ì´ë¯¸ DBì— ìˆëŠ” ê²½ë¡œëŠ” ë¬´ì‹œ(Skip)"**í•˜ë„ë¡ ì§œì—¬ ìˆì–´ì„œ, **ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ë§Œ ì™ ê³¨ë¼ì„œ** ë¹ ë¥´ê²Œ ë“±ë¡ë©ë‹ˆë‹¤.

**Q. DB íŒŒì¼ì„ ì‹¤ìˆ˜ë¡œ ì§€ì› ìŠµë‹ˆë‹¤!**  
A. ê±±ì • ë§ˆì„¸ìš”. `data/metadata.db` íŒŒì¼ì€ ì–¸ì œë“  ë‹¤ì‹œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
`final_indexing_v2.py` ìŠ¤í¬ë¦½íŠ¸ë‚˜ ê°œë³„ ëª…ë ¹ì–´ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ë©´ íŒŒì¼ë“¤ì„ ìŠ¤ìº”í•˜ì—¬ DBë¥¼ ìƒˆë¡œ êµ¬ì¶•í•´ ì¤ë‹ˆë‹¤.

---
**ìµœì¢… ìˆ˜ì •ì¼**: 2026-02-05
