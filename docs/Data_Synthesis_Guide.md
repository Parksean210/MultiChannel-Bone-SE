# π§ λ°μ΄ν„° ν•©μ„± κ°€μ΄λ“ (Data Synthesis Guide)

λ³Έ λ¬Έμ„λ” μμ„±κ³Ό λ…Έμ΄μ¦ λ°μ΄ν„°λ¥Ό RIR(κ³µκ°„ μ„ν„μ¤ μ‘λ‹µ)κ³Ό κ²°ν•©ν•μ—¬ ν•™μµμ© λ©€ν‹°μ±„λ„ λ°μ΄ν„°λ¥Ό μ‹¤μ‹κ°„(On-the-fly)μΌλ΅ μƒμ„±ν•λ” κ³Όμ •μ„ μ„¤λ…ν•©λ‹λ‹¤.

---

## π› οΈ 1. ν•©μ„± λ°©μ‹: On-the-fly Synthesis

λ³Έ ν”„λ΅μ νΈλ” κ³ μ •λ λ°μ΄ν„°μ…‹μ„ ν•λ“λ””μ¤ν¬μ— λ―Έλ¦¬ λ§λ“¤μ–΄λ‘μ§€ μ•κ³ , **ν•™μµ λ£¨ν”„κ°€ λμ•„κ° λ• μ‹¤μ‹κ°„μΌλ΅ ν•©μ„±**ν•©λ‹λ‹¤.

- **μ¥μ **: μ΅°ν•© κ°€λ¥ν• μ‚¬λ΅€κ°€ κΈ°ν•κΈ‰μμ μΌλ΅ λμ–΄λ‚ μ¤λ²„ν”Όν…μ„ λ°©μ§€ν•©λ‹λ‹¤ (μμ„± 25λ§κ° x μ†μ 2λ§κ° x RIR 1μ²κ°).
- **ν•µμ‹¬ μ—”μ§„**: `src/data/dataset.py`μ `SpatialMixingDataset` ν΄λμ¤.

---

## π—οΈ 2. λ°μ΄ν„° ν•©μ„± κ³Όμ • (Mixing Pipeline)

`SpatialMixingDataset` μ•„μΉ΄μ΄λΈλ” `__getitem__`μ΄ νΈμ¶λ  λ•λ§λ‹¤ λ‹¤μ 6λ‹¨κ³„ μ‘μ—…μ„ μν–‰ν•©λ‹λ‹¤.

### Step 1: Resource Sampling
- DBμ—μ„ **Speech 1κ° + RIR 1κ°**λ¥Ό λλ¤ν•κ² μ„ νƒν•©λ‹λ‹¤.
- μ„ νƒλ RIR λ©”νƒ€λ°μ΄ν„°μ—μ„ ν•„μ”ν• **ν™κ²½ μ†μ(Noise) κ°μ $N$**μ„ ν™•μΈν•©λ‹λ‹¤ ($N \ge 1$).

### Step 2: RIR Application (Convolution)
- **Target Speech**: RIRμ 0λ² μ†μ¤ μ„μΉ(μ‚¬μ©μ μ… μ„μΉ)λ¥Ό μ‚¬μ©ν•μ—¬ 5μ±„λ„ κ³µκ°„μμ„ μƒμ„±ν•©λ‹λ‹¤.
- **RIR Convolution**: `scipy.signal.convolve`λ¥Ό μ‚¬μ©ν•μ—¬ μν–¥ ν•λ“μ›¨μ–΄ μ„μΉμ— λ”°λ¥Έ μ‹μ°¨μ™€ μ”ν–¥μ„ μ…ν™λ‹λ‹¤.

### Step 3: BCM (Bone Conduction) Modeling
5λ² μ±„λ„(λ§μ§€λ§‰ μ±„λ„)μ€ κ³¨μ „λ„ μ„Όμ„λ΅ κ°„μ£Όν•λ©°, λ‹¤μ λ¬Όλ¦¬ νΉμ„±μ„ μ μ©ν•©λ‹λ‹¤:
1. **LPF (Low Pass Filter)**: 4μ°¨ λ²„ν„°μ›μ¤ ν•„ν„°λ¥Ό μ‚¬μ©ν•μ—¬ μ•½ 500Hz μ΄μƒμ κ³ μ£Όνλ¥Ό μ°¨λ‹¨ν•©λ‹λ‹¤ (μ„±λ€ μ§„λ™ νΉμ„±).
2. **Isolation**: μ™Έλ¶€ μ†μμ€ κ³µκΈ° μ „λ„ λ§μ΄ν¬λ³΄λ‹¤ ν„μ €ν λ‚®κ² μ μ…λλ„λ΅ κ°μ‡„(κΈ°λ³Έ 20dB)λ¥Ό μ μ©ν•©λ‹λ‹¤.

### Step 4: Noise Spatialization
- DBμ—μ„ $N$κ°μ λ…Έμ΄μ¦ νμΌμ„ λ¬΄μ‘μ„λ΅ μ„ νƒν•©λ‹λ‹¤.
- RIRμ— κΈ°λ΅λ $N$κ°μ μ†μμ› μ„μΉ(Sources 1..N)μ— κ°κ° λ…Έμ΄μ¦λ¥Ό μ…ν€ 5μ±„λ„ κ³µκ°„ μ†μμ„ λ§λ“­λ‹λ‹¤.

### Step 5: SNR Scaling
- **ν„μ‹¤μ μΈ SNR**: μ†μμ ν¬κΈ°λ” BCM μ±„λ„μ΄ μ•„λ‹, **0~3λ² κ³µκΈ° λ§μ΄ν¬(Air Mics)μ ν‰κ·  μ—λ„μ§€**λ¥Ό κΈ°μ¤€μΌλ΅ μ΅°μ λ©λ‹λ‹¤.
- μ„¤μ •λ `snr_range` (μ: -5~20dB) λ‚΄μ—μ„ λ¬΄μ‘μ„λ΅ SNRμ„ κ²°μ •ν•κ³  μ†μ λ λ²¨μ„ λ§μ¶¥λ‹λ‹¤.

### Step 6: Target Alignment (Direct Path)
- λ¨λΈμ μ •λ‹µ(Clean)μΌλ΅ μ‚¬μ©ν•κΈ° μ„ν•΄, RIRμ **Peak(Direct Path)** μ •λ³΄λ§ μ¶”μ¶ν•μ—¬ μ‹κ°„ μ¶•μ΄ μ •λ ¬λ 'Reverb-free' νƒ€κ² μ‹ νΈλ¥Ό μƒμ„±ν•©λ‹λ‹¤.

---

## π’» 3. μ‚¬μ© μμ‹ (Python Code)

ν•™μµ μ½”λ“λ‚ λ…ΈνΈλ¶μ—μ„ λ‹¤μκ³Ό κ°™μ΄ κ°„λ‹¨ν μ‚¬μ©ν•  μ μμµλ‹λ‹¤.

```python
from src.data.dataset import SpatialMixingDataset

# λ°μ΄ν„°μ…‹ μ΄κΈ°ν™”
dataset = SpatialMixingDataset(
    db_path="data/metadata.db",
    target_sr=16000,
    snr_range=(-5, 20),
    is_eval=False
)

# λ°μ΄ν„° ν• κ° λ½‘κΈ°
sample = dataset[0]

noisy = sample['noisy']        # (5, Samples) - λ¨λΈ μ…λ ¥
clean = sample['clean']        # (5, Samples) - μ”ν–¥μ΄ ν¬ν•¨λ κΉ¨λ—ν• μμ„±
target = sample['aligned_dry'] # (5, Samples) - μ‹κ°„ μ •λ ¬λ λ¬΄μ”ν–¥ μμ„± (ν•™μµ νƒ€κ² κ¶μ¥)
snr = sample['snr']            # μ μ©λ SNR κ°’
```

---

## π¦ 4. μ„¤μ • λ° νλΌλ―Έν„°

ν•©μ„± λ΅μ§μ— μν–¥μ„ μ£Όλ” νλΌλ―Έν„°λ” `src/simulation/config.py`μ—μ„ κ΄€λ¦¬ν•©λ‹λ‹¤.

| νλΌλ―Έν„° | κΈ°λ³Έκ°’ | μ„¤λ… |
| :--- | :--- | :--- |
| `bcm_cutoff_hz` | `500.0` | κ³¨μ „λ„ μ„Όμ„μ LPF μ»·μ¤ν”„ |
| `bcm_noise_attenuation_db` | `20.0` | κ³¨μ „λ„ μ„Όμ„μ μ†μ μ°¨νμ¨ |
| `snr_range` | `(-5, 20)` | ν•©μ„± μ‹ λ¬΄μ‘μ„ SNR λ²”μ„ |

---

## β΅ 5. ν (Tips)

* **μ„±λ¥ μµμ ν™”**: μ‹¤μ‹κ°„ ν•©μ„±μ€ CPUλ¥Ό λ§μ΄ μ‚¬μ©ν•©λ‹λ‹¤. `DataLoader`μ `num_workers`λ¥Ό μ μ ν(μ: μ½”μ–΄ μμ μ λ° μ΄μƒ) ν• λ‹Ήν•μ„Έμ”.
* **κ²€μ**: `scripts/generate_samples.py`λ¥Ό μ‹¤ν–‰ν•λ©΄ ν•©μ„±λ κ²°κ³Όλ¥Ό μ§μ ‘ λ“¤μ–΄λ³΄κ³  νν•μ„ ν™•μΈν•  μ μμµλ‹λ‹¤.
